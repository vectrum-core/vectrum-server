#!/usr/bin/env node
const cfg = require('../src/config');
const log = require('../src/logger').getLogger('VECTRUM-SERVER');
const connectDb = require('../src/mongoose');
const Server = require('../src/server');
const Bot = require('../src/bot');
const Mailer = require('../src/mailer');



const env = cfg.get('env');
log.info('The application launched in mode: "%s".', env);

connectDb('VECTRUM-SERVER')
  .then(async (mongoose = { connection }) => {
    log.info('Connected to MongoDB.');

    const timeout = 1;
    setTimeout(async () => {
      const bot = Bot();
      const mailer = Mailer();
      //mailer.sendVerifyYourEmail({ address: 'a.n.ivannikov@yandex.ru' });
      const server = new Server({
        dbConnection: mongoose.connection,
        bot,
        mailer,
      });
      server.start();
      bot.launch();
    }, timeout);

  }).catch((error) => {
    log.error('Application launch failed! error:', error);
    process.exit(1);
  });
